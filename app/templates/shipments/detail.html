{% extends "base.html" %}

{% block title %}Отправка {{ shipment.shipment_number }} - Warehouse{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Отправка: {{ shipment.shipment_number }}</h1>
    <div>
        <a href="{{ url_for('shipments.shipments_list') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Назад к списку
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Информация об отправке</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th width="140">Номер отправки:</th>
                        <td><code>{{ shipment.shipment_number }}</code></td>
                    </tr>
                    <tr>
                        <th>Статус:</th>
                        <td>
                            <span class="badge 
                                {% if shipment.status == 'draft' %}bg-secondary
                                {% elif shipment.status == 'preparing' %}bg-warning
                                {% elif shipment.status == 'sent' %}bg-info
                                {% elif shipment.status == 'delivered' %}bg-success
                                {% else %}bg-light text-dark{% endif %}">
                                {{ shipment.status|upper }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>Дата создания:</th>
                        <td>{{ shipment.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                    </tr>
                    <tr>
                        <th>Дата отправки:</th>
                        <td>
                            {% if shipment.shipment_date %}
                                {{ shipment.shipment_date.strftime('%d.%m.%Y %H:%M') }}
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Ожидаемая доставка:</th>
                        <td>
                            {% if shipment.expected_delivery_date %}
                                {{ shipment.expected_delivery_date.strftime('%d.%m.%Y') }}
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Статистика отправки</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h3 class="text-primary mb-1">{{ shipment.items|length }}</h3>
                            <small class="text-muted">Позиций</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div>
                            <h3 class="text-success mb-1">
                                {% set total_packages = 0 %}
                                {% for item in shipment.items %}
                                    {% set total_packages = total_packages + item.quantity %}
                                {% endfor %}
                                {{ total_packages }}
                            </h3>
                            <small class="text-muted">Упаковок</small>
                        </div>
                    </div>
                </div>
                <div class="mt-3 p-3 bg-light rounded">
                    <small class="text-muted">
                        <strong>Общее количество товара:</strong>
                        {% set total_units = 0 %}
                        {% for item in shipment.items %}
                            {% set total_units = total_units + (item.quantity * item.package.package_quantity) %}
                        {% endfor %}
                        {{ total_units }} шт.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">Состав отправки</h5>
    </div>
    <div class="card-body p-0">
        {% if shipment.items %}
            <div class="table-responsive">
                <table class="table table-bordered mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="20%">Товар</th>
                            <th width="10%">Размер</th>
                            <th width="10%">Цвет</th>
                            <th width="15%">Артикул</th>
                            <th width="10%">В упаковке</th>
                            <th width="10%">Кол-во упаковок</th>
                            <th width="15%">Общее кол-во (шт)</th>
                            <th width="10%">Статус</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in shipment.items %}
                        <tr>
                            <td class="align-middle">
                                <strong>
                                    {% if item.package.variation and item.package.variation.product %}
                                        {{ item.package.variation.product.name }}
                                    {% else %}
                                        <span class="text-muted">Товар не найден</span>
                                    {% endif %}
                                </strong>
                            </td>
                            <td class="align-middle">
                                {% if item.package.variation and item.package.variation.size %}
                                    {{ item.package.variation.size.name }}
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td class="align-middle">
                                {% if item.package.variation and item.package.variation.color %}
                                    <span class="color-badge" style="background-color: {{ get_color_hex(item.package.variation.color.name) }};"></span>
                                    {{ item.package.variation.color.name }}
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td class="align-middle">
                                <code>{{ item.package.sku }}</code>
                            </td>
                            <td class="text-center align-middle">
                                <span class="badge bg-info">{{ item.package.package_quantity }} шт.</span>
                            </td>
                            <td class="text-center align-middle">
                                <span class="fw-bold text-primary">{{ item.quantity }} уп.</span>
                            </td>
                            <td class="text-center align-middle">
                                <span class="fw-bold text-success">{{ item.quantity * item.package.package_quantity }} шт.</span>
                            </td>
                            <td class="text-center align-middle">
                                <span class="badge bg-success">В отправке</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-4">
                <p class="text-muted">Отправка не содержит товаров</p>
            </div>
        {% endif %}
    </div>
</div>

{% if shipment.status == 'preparing' %}
<div class="mt-4">
    <div class="card border-warning">
        <div class="card-header bg-warning text-dark">
            <h5 class="card-title mb-0">Действия с отправкой</h5>
        </div>
        <div class="card-body">
            <p class="mb-3">Отправка готова к подтверждению. После подтверждения статус изменится на "Отправлено".</p>
            <a href="{{ url_for('shipments.confirm_shipment', shipment_id=shipment.id) }}" 
               class="btn btn-success"
               onclick="return confirm('Подтвердить отправку {{ shipment.shipment_number }}?')">
                <i class="bi bi-check-lg me-1"></i> Подтвердить отправку
            </a>
        </div>
    </div>
</div>
{% endif %}

<style>
.color-badge {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 8px;
    border: 1px solid #dee2e6;
    vertical-align: middle;
}

.table th {
    vertical-align: middle;
    text-align: center;
    font-weight: 600;
}

.table td {
    vertical-align: middle;
}

.border-end {
    border-right: 1px solid #dee2e6 !important;
}
</style>
{% endblock %}