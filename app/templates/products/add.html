{% extends "base.html" %}

{% block title %}Добавить товар - Warehouse{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">Добавить новый товар</h4>
            </div>
            <div class="card-body">
                <form method="POST" id="productForm">
                    <!-- Основная информация о товаре -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Название товара *</label>
                            <input type="text" class="form-control" id="name" name="name" required
                                   placeholder="Например: Носки спортивные">
                        </div>
                        <div class="col-md-6">
                            <label for="category_id" class="form-label">Категория *</label>
                            <select class="form-select" id="category_id" name="category_id" required>
                                <option value="">Выберите категорию</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <a href="{{ url_for('categories.add_category') }}">Добавить новую категорию</a>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Описание</label>
                        <textarea class="form-control" id="description" name="description" rows="3"
                                  placeholder="Описание товара"></textarea>
                    </div>

                    <hr>
                    <h5 class="mb-3">Неупакованные вариации (размеры и цвета)</h5>
                    <p class="text-muted">Выберите комбинации размеров и цветов для россыпи товара. Для каждой комбинации будет создана вариация с упаковкой 1 шт.</p>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Размеры *</label>
                            <div class="border p-3" style="max-height: 200px; overflow-y: auto;">
                                {% for size in sizes %}
                                <div class="form-check">
                                    <input class="form-check-input size-checkbox" type="checkbox"
                                           name="size_ids[]" value="{{ size.id }}" id="size_{{ size.id }}">
                                    <label class="form-check-label" for="size_{{ size.id }}">
                                        {{ size.name }}{% if size.description %} ({{ size.description }}){% endif %}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Цвета *</label>
                            <div class="border p-3" style="max-height: 200px; overflow-y: auto;">
                                {% for color in colors %}
                                <div class="form-check">
                                    <input class="form-check-input color-checkbox" type="checkbox"
                                           name="color_ids[]" value="{{ color.id }}" id="color_{{ color.id }}">
                                    <label class="form-check-label" for="color_{{ color.id }}">
                                        <span class="color-badge" style="background-color: {{ color.hex_code or '#6c757d' }};"></span>
                                        {{ color.name }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong>Будут созданы неупакованные вариации:</strong>
                        <div id="variations-preview" class="mt-2 p-2 border rounded bg-light">
                            <small class="text-muted">Выберите размеры и цвета для просмотра комбинаций</small>
                        </div>
                    </div>

                    <hr>
                    <h5 class="mb-3">Упаковки товара</h5>
                    <p class="text-muted">Добавьте упаковки с артикулами для выбранных комбинаций размер-цвет</p>

                    <div id="packages-container">
                        <div class="package-item card mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label">Размер *</label>
                                        <select class="form-select package-size" name="package_size_ids[]" required>
                                            <option value="">Выберите размер</option>
                                            {% for size in sizes %}
                                            <option value="{{ size.id }}">{{ size.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Цвет *</label>
                                        <select class="form-select package-color" name="package_color_ids[]" required>
                                            <option value="">Выберите цвет</option>
                                            {% for color in colors %}
                                            <option value="{{ color.id }}">{{ color.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Штук в упаковке *</label>
                                        <input type="number" class="form-control" name="package_quantities[]"
                                               value="5" min="1" required placeholder="5, 10, 20">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Артикул (SKU) *</label>
                                        <input type="text" class="form-control" name="skus[]" required
                                               placeholder="Уникальный артикул">
                                    </div>
                                    <div class="col-md-1 d-flex align-items-end">
                                        <button type="button" class="btn btn-danger remove-package" disabled>
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="button" id="add-package" class="btn btn-outline-primary mb-3">
                        <i class="bi bi-plus-circle"></i> Добавить упаковку
                    </button>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('products.products_list') }}" class="btn btn-secondary me-md-2">Отмена</a>
                        <button type="submit" class="btn btn-primary">Сохранить товар</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обновление превью вариаций
    function updateVariationsPreview() {
        const selectedSizes = Array.from(document.querySelectorAll('.size-checkbox:checked'))
            .map(cb => {
                const label = cb.nextElementSibling;
                return label.textContent.trim().split(' (')[0]; // Берем только название без описания
            });
        const selectedColors = Array.from(document.querySelectorAll('.color-checkbox:checked'))
            .map(cb => {
                const label = cb.nextElementSibling;
                return label.textContent.trim();
            });

        const preview = document.getElementById('variations-preview');

        if (selectedSizes.length === 0 || selectedColors.length === 0) {
            preview.innerHTML = '<small class="text-muted">Выберите размеры и цвета для просмотра комбинаций</small>';
            return;
        }

        let html = '<div class="row g-1">';
        selectedSizes.forEach(size => {
            selectedColors.forEach(color => {
                html += `<div class="col-12"><small>• ${size} / ${color} (1 шт/уп)</small></div>`;
            });
        });
        html += `<div class="col-12 mt-2"><small class="text-success">Всего: ${selectedSizes.length * selectedColors.length} вариаций</small></div>`;
        html += '</div>';
        preview.innerHTML = html;
    }

    // Слушатели для чекбоксов
    document.querySelectorAll('.size-checkbox, .color-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateVariationsPreview);
    });

    // Логика для упаковок
    const packagesContainer = document.getElementById('packages-container');
    const addPackageButton = document.getElementById('add-package');

    addPackageButton.addEventListener('click', function() {
        const newPackage = packagesContainer.firstElementChild.cloneNode(true);
        const inputs = newPackage.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (input.type !== 'hidden') {
                if (input.tagName === 'SELECT') {
                    input.value = '';
                } else if (input.name.includes('quantities')) {
                    input.value = '5';
                } else {
                    input.value = '';
                }
            }
        });

        const removeBtn = newPackage.querySelector('.remove-package');
        removeBtn.disabled = false;
        removeBtn.addEventListener('click', function() {
            if (packagesContainer.children.length > 1) {
                newPackage.remove();
            }
        });

        packagesContainer.appendChild(newPackage);
    });

    // Удаление упаковок
    packagesContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-package') ||
            e.target.closest('.remove-package')) {
            const btn = e.target.classList.contains('remove-package') ? e.target : e.target.closest('.remove-package');
            if (packagesContainer.children.length > 1) {
                btn.closest('.package-item').remove();
            }
        }
    });

    // Валидация формы
    document.getElementById('productForm').addEventListener('submit', function(e) {
        const selectedSizes = document.querySelectorAll('.size-checkbox:checked').length;
        const selectedColors = document.querySelectorAll('.color-checkbox:checked').length;

        if (selectedSizes === 0 || selectedColors === 0) {
            e.preventDefault();
            alert('Пожалуйста, выберите хотя бы один размер и один цвет для создания вариаций товара.');
            return;
        }

        // Проверяем уникальность артикулов
        const skus = Array.from(document.querySelectorAll('input[name="skus[]"]')).map(input => input.value.trim());
        const uniqueSkus = new Set(skus.filter(sku => sku !== ''));

        if (uniqueSkus.size !== skus.filter(sku => sku !== '').length) {
            e.preventDefault();
            alert('Обнаружены дублирующиеся артикулы. Пожалуйста, убедитесь, что все артикулы уникальны.');
            return;
        }
    });
});
</script>

<style>
.color-badge {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 8px;
    border: 1px solid #dee2e6;
    vertical-align: middle;
}

.form-check-label {
    cursor: pointer;
}

.size-checkbox:checked + .form-check-label,
.color-checkbox:checked + .form-check-label {
    font-weight: 600;
    color: #0d6efd;
}

.package-item {
    border-left: 4px solid #0d6efd;
}

.remove-package:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>
{% endblock %}
{% endblock %}