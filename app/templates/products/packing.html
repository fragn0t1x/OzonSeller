<!-- app/templates/products/packing.html -->
{% extends "base.html" %}

{% block title %}Упаковка товара - {{ product.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Упаковка товара: {{ product.name }}</h1>
    <div>
        <a href="{{ url_for('products.product_detail', product_id=product.id) }}" class="btn btn-secondary me-2">
            <i class="bi bi-arrow-left"></i> Назад к товару
        </a>
        <a href="{{ url_for('products.products_list') }}" class="btn btn-outline-secondary">
            К списку товаров
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h4 class="card-title mb-0">Упаковка товара</h4>
            </div>
            <div class="card-body">
                {% if packing_data %}
                <form method="POST" id="packingForm">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="packingTable">
                            <thead>
                                <tr>
                                    <th>Размер</th>
                                    <th>Цвет</th>
                                    <th>Доступно (шт)</th>
                                    <th>Артикул упаковки</th>
                                    <th>Штук в упаковке</th>
                                    <th>Макс. упаковок</th>
                                    <th>Кол-во упаковок</th>
                                    <th>Потребуется (шт)</th>
                                    <!-- УБИРАЕМ СТОЛБЕЦ "Останется" -->
                                </tr>
                            </thead>
                            <tbody>
                                {% for group in packing_data %}
                                {% set variation = group.variation %}
                                {% set group_id = variation.id %}

                                <!-- Заголовок группы -->
                                <tr class="table-group-header" data-group="{{ group_id }}">
                                    <td colspan="8" class="bg-light fw-bold">
                                        {{ variation.size or '—' }} / {{ variation.color or '—' }}
                                        - Доступно: <span id="total_available_{{ group_id }}">{{ group.remaining_quantity }}</span> шт.
                                    </td>
                                </tr>

                                {% for package in group.packages %}
                                <tr class="packing-row" data-group="{{ group_id }}" data-package-quantity="{{ package.package_quantity }}">
                                    <td>{{ variation.size or '—' }}</td>
                                    <td>{{ variation.color or '—' }}</td>
                                    <td class="text-success fw-bold">
                                        <span id="available_{{ group_id }}_{{ package.id }}">{{ group.remaining_quantity }}</span>
                                    </td>
                                    <td><code>{{ package.sku }}</code></td>
                                    <td>{{ package.package_quantity }}</td>
                                    <td class="fw-bold">
                                        <span id="max_{{ group_id }}_{{ package.id }}">{{ group.remaining_quantity // package.package_quantity }}</span>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control packing-input"
                                               name="quantity_{{ group_id }}_{{ package.id }}"
                                               id="input_{{ group_id }}_{{ package.id }}"
                                               value="0" min="0"
                                               max="{{ group.remaining_quantity // package.package_quantity }}"
                                               placeholder="0"
                                               data-variation="{{ group_id }}"
                                               data-package="{{ package.id }}"
                                               data-package-qty="{{ package.package_quantity }}"
                                               oninput="updateQuantities(this)">
                                    </td>
                                    <td class="text-info fw-bold">
                                        <span id="required_{{ group_id }}_{{ package.id }}">0</span>
                                    </td>
                                    <!-- УБИРАЕМ ЯЧЕЙКУ "Останется" -->
                                </tr>
                                {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Комментарий</label>
                        <textarea class="form-control" name="comment" rows="2"
                                  placeholder="Комментарий к упаковке"></textarea>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('products.product_detail', product_id=product.id) }}" class="btn btn-secondary me-md-2">Отмена</a>
                        <button type="submit" class="btn btn-warning">Упаковать товар</button>
                    </div>
                </form>
                {% else %}
                <div class="text-center py-4">
                    <p class="text-muted">Нет товаров доступных для упаковки</p>
                    <a href="{{ url_for('products.product_incoming', product_id=product.id) }}" class="btn btn-success me-2">
                        <i class="bi bi-box-arrow-in-down"></i> Добавить приход товара
                    </a>
                    <a href="{{ url_for('products.product_detail', product_id=product.id) }}" class="btn btn-primary">
                        <i class="bi bi-arrow-left"></i> Назад к товару
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Объект для хранения текущих количеств по группам
let groupQuantities = {};

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Инициализируем объект количеств
    const groups = document.querySelectorAll('.table-group-header');
    groups.forEach(group => {
        const groupId = group.getAttribute('data-group');
        // Берем начальное количество из текста заголовка
        const headerText = group.querySelector('td').textContent;
        const match = headerText.match(/Доступно: (\d+) шт\./);
        if (match) {
            groupQuantities[groupId] = parseInt(match[1]);
        } else {
            // Если не нашли в заголовке, берем из первой строки
            const firstRow = document.querySelector(`.packing-row[data-group="${groupId}"]`);
            if (firstRow) {
                const availableElement = firstRow.querySelector('[id^="available_"]');
                if (availableElement) {
                    groupQuantities[groupId] = parseInt(availableElement.textContent);
                }
            }
        }
    });

    console.log('Initial quantities:', groupQuantities); // Для отладки
});

function updateQuantities(input) {
    const variationId = input.getAttribute('data-variation');
    const packageId = input.getAttribute('data-package');
    const packageQty = parseInt(input.getAttribute('data-package-qty'));
    const quantity = parseInt(input.value) || 0;

    console.log('Updating:', {variationId, packageId, packageQty, quantity}); // Для отладки

    // Рассчитываем требуемое количество штук
    const requiredUnits = quantity * packageQty;

    // Обновляем отображение требуемого количества
    document.getElementById(`required_${variationId}_${packageId}`).textContent = requiredUnits;

    // Пересчитываем все вводы в этой группе
    recalculateGroup(variationId);
}

function recalculateGroup(variationId) {
    // Получаем все input'ы в этой группе
    const inputs = document.querySelectorAll(`.packing-input[data-variation="${variationId}"]`);

    // Начальное доступное количество
    let totalAvailable = groupQuantities[variationId] || 0;
    let totalUsed = 0;

    console.log('Recalculating group:', variationId, 'Total available:', totalAvailable); // Для отладки

    // Сначала считаем общее использованное количество
    inputs.forEach(input => {
        const quantity = parseInt(input.value) || 0;
        const packageQty = parseInt(input.getAttribute('data-package-qty'));
        totalUsed += quantity * packageQty;
    });

    console.log('Total used:', totalUsed); // Для отладки

    // Обновляем общее доступное количество в заголовке группы
    const remainingTotal = totalAvailable - totalUsed;
    document.getElementById(`total_available_${variationId}`).textContent = remainingTotal;

    // Теперь обновляем каждую строку
    inputs.forEach(input => {
        const packageId = input.getAttribute('data-package');
        const packageQty = parseInt(input.getAttribute('data-package-qty'));
        const currentQuantity = parseInt(input.value) || 0;

        // Доступное количество для этой строки
        const availableForThisRow = totalAvailable - (totalUsed - (currentQuantity * packageQty));

        // Максимальное количество упаковок для этой строки
        const maxPackages = Math.floor(availableForThisRow / packageQty);

        // Обновляем максимальное значение input
        input.setAttribute('max', maxPackages);
        document.getElementById(`max_${variationId}_${packageId}`).textContent = maxPackages;

        // Если текущее значение превышает новый максимум, уменьшаем его
        if (currentQuantity > maxPackages) {
            input.value = maxPackages;
            const newRequired = maxPackages * packageQty;
            document.getElementById(`required_${variationId}_${packageId}`).textContent = newRequired;
            // Пересчитываем использованное количество после изменения
            totalUsed = totalUsed - (currentQuantity * packageQty) + (maxPackages * packageQty);
        }

        // Обновляем отображение доступного количества для этой строки
        document.getElementById(`available_${variationId}_${packageId}`).textContent = availableForThisRow;

        console.log('Row updated:', {packageId, availableForThisRow, maxPackages}); // Для отладки
    });
}

// Валидация формы перед отправкой
document.getElementById('packingForm').addEventListener('submit', function(e) {
    let hasErrors = false;
    const inputs = document.querySelectorAll('.packing-input');

    inputs.forEach(input => {
        const quantity = parseInt(input.value) || 0;
        if (quantity > 0) {
            const variationId = input.getAttribute('data-variation');
            const packageId = input.getAttribute('data-package');
            const packageQty = parseInt(input.getAttribute('data-package-qty'));
            const requiredUnits = quantity * packageQty;

            const availableElement = document.getElementById(`available_${variationId}_${packageId}`);
            const available = parseInt(availableElement.textContent);

            if (requiredUnits > available) {
                hasErrors = true;
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
            }
        }
    });

    if (hasErrors) {
        e.preventDefault();
        alert('Некоторые количества превышают доступные остатки. Пожалуйста, проверьте введенные данные.');
    }
});
</script>

<style>
.table-group-header {
    background-color: #e9ecef !important;
}

.packing-row:hover {
    background-color: #f8f9fa;
}

.is-invalid {
    border-color: #dc3545 !important;
}

.table th {
    background-color: #f8f9fa;
    vertical-align: middle;
    text-align: center;
}

.table td {
    vertical-align: middle;
}
</style>
{% endblock %}