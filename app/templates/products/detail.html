<!-- app/templates/products/detail.html - Исправленная версия -->
{% extends "base.html" %}

{% block title %}{{ product.name }} - Детальная информация{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ product.name }}</h1>
    <div>
        <a href="{{ url_for('products.product_incoming', product_id=product.id) }}"
           class="btn btn-success me-2">
            <i class="bi bi-box-arrow-in-down"></i> Приход товара
        </a>
        <a href="{{ url_for('products.product_packing', product_id=product.id) }}"
           class="btn btn-warning me-2">
            <i class="bi bi-box-seam"></i> Упаковка
        </a>
        <a href="{{ url_for('products.products_list') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Назад к списку
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Основная информация</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th width="120">Категория:</th>
                        <td>{{ product.category.name if product.category else 'Не указана' }}</td>
                    </tr>
                    <tr>
                        <th>Описание:</th>
                        <td>{{ product.description or '—' }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">Остатки товара</h5>
    </div>
    <div class="card-body p-0">
        {% if size_color_groups %}
            <div class="table-responsive">
                <table class="table table-bordered mb-0">
                    <thead class="table-header-fixed">
                        <tr>
                            <th width="15%">Цвет</th>
                            <th width="15%">Общее кол-во<br><small class="text-muted">(шт.)</small></th>
                            <th width="15%">Неупакованные<br><small class="text-muted">(шт.)</small></th>
                            <th width="35%">Упакованные</th>
                            <th width="20%">Прогресс упаковки</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set grouped_by_size = {} %}
                        {% for group in size_color_groups %}
                            {% set size_key = group.size or 'Без размера' %}
                            {% if size_key not in grouped_by_size %}
                                {% set _ = grouped_by_size.update({size_key: []}) %}
                            {% endif %}
                            {% set _ = grouped_by_size[size_key].append(group) %}
                        {% endfor %}

                        {% for size, groups in grouped_by_size.items() %}
                            <tr class="size-group-header">
                                <td colspan="5" class="text-white fw-bold fs-5">
                                    <i class="bi bi-tag-fill me-2"></i>Размер: {{ size }}
                                    <small class="opacity-90 ms-2">• {{ groups|length }} цветов</small>
                                </td>
                            </tr>

                            {% for group in groups %}
                            <tr class="color-row {% if loop.index % 2 == 0 %}table-light{% else %}table-default{% endif %}">
                                <td class="align-middle">
                                    <span class="color-badge" style="background-color: {{ get_color_hex(group.color) }}; border: 2px solid #dee2e6;"></span>
                                    <strong>{{ group.color or '—' }}</strong>
                                </td>

                                <td class="text-center align-middle">
                                    {% set packed_quantities = [] %}
                                    {% for package in group.packages %}
                                        {% if package.quantity > 0 %}
                                            {% set _ = packed_quantities.append(package.quantity * package.package_quantity) %}
                                        {% endif %}
                                    {% endfor %}

                                    {% set total_packed = packed_quantities | sum %}
                                    {% set total_units = group.unpacked_quantity + total_packed %}

                                    <span class="fw-bold fs-5 text-primary">{{ total_units }}</span>
                                </td>

                                <td class="text-center align-middle">
                                    <span class="fw-bold {% if group.unpacked_quantity > 0 %}text-success{% else %}text-muted{% endif %}">
                                        {{ group.unpacked_quantity }}
                                    </span>
                                </td>

                                <td>
                                    {% set has_packed = false %}
                                    {% for package in group.packages %}
                                        {% if package.quantity > 0 %}
                                            {% set has_packed = true %}
                                            <div class="packed-item mb-2 p-2 border rounded bg-light">
                                                <div class="row align-items-center">
                                                    <div class="col-5">
                                                        <strong>Артикул:</strong><br>
                                                        <code class="small">{{ package.sku }}</code>
                                                    </div>
                                                    <div class="col-3">
                                                        <strong>В упаковке:</strong><br>
                                                        <span class="text-info">{{ package.package_quantity }} шт.</span>
                                                    </div>
                                                    <div class="col-4">
                                                        <strong>Упаковано:</strong><br>
                                                        <span class="fw-bold text-primary">
                                                            {{ package.quantity }} уп.
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    <!-- УБИРАЕМ ПРОЧЕРК ЕСЛИ ЕСТЬ УПАКОВАННЫЕ -->
                                </td>

                                <td class="text-center align-middle">
                                    {% set packed_quantities = [] %}
                                    {% for package in group.packages %}
                                        {% if package.quantity > 0 %}
                                            {% set _ = packed_quantities.append(package.quantity * package.package_quantity) %}
                                        {% endif %}
                                    {% endfor %}

                                    {% set total_packed = packed_quantities | sum %}
                                    {% set total_units = group.unpacked_quantity + total_packed %}

                                    {% if total_units > 0 %}
                                        {% set packing_percentage = (total_packed / total_units * 100)|round(1) %}
                                        <div class="progress-container">
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-success"
                                                     style="width: {{ packing_percentage }}%;"
                                                     role="progressbar"
                                                     aria-valuenow="{{ packing_percentage }}"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                    {{ packing_percentage|int }}%
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                {{ total_packed }} из {{ total_units }} шт.
                                            </small>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                            </tr>

                            {% if not loop.last %}
                                <tr class="color-separator">
                                    <td colspan="5" style="height: 2px; background-color: #e9ecef;"></td>
                                </tr>
                            {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% else %}
            <div class="text-center py-4">
                <p class="text-muted">Товарные позиции не найдены</p>
                <a href="{{ url_for('products.add_product') }}" class="btn btn-primary">Добавить позиции</a>
            </div>
        {% endif %}
    </div>
</div>

<style>
/* Фиксированный заголовок таблицы */
.table-header-fixed {
    position: sticky;
    top: 0;
    z-index: 10;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.table-responsive {
    max-height: 70vh;
    overflow-y: auto;
}

.size-group-header td {
    background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%) !important;
    border: none !important;
    position: relative;
    position: sticky;
    top: 45px; /* Высота заголовка таблицы */
    z-index: 5;
}

.size-group-header td::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: rgba(255,255,255,0.3);
}

.color-row:hover {
    background-color: #fff5f5 !important;
}

.color-badge {
    display: inline-block;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-right: 10px;
    vertical-align: middle;
}

.packed-item {
    background: #fffaf0;
    border-left: 4px solid #ff7e5f !important;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.packed-item:hover {
    background: #fff5e6;
    transform: translateX(2px);
}

.color-separator td {
    padding: 0 !important;
    background-color: #e9ecef;
}

.table th {
    vertical-align: middle;
    text-align: center;
    font-weight: 600;
}

.table td {
    vertical-align: middle;
}

.fs-5 {
    font-size: 1.25rem !important;
}

.progress-container {
    min-width: 100px;
}

.progress {
    background-color: #e9ecef;
    border-radius: 5px;
    margin-bottom: 5px;
}

.progress-bar {
    border-radius: 5px;
    font-size: 0.8rem;
    line-height: 20px;
    font-weight: 500;
}

.table-responsive {
    font-size: 0.9rem;
}

.packed-item .row {
    margin: 0 -5px;
}

.packed-item .col-2,
.packed-item .col-3,
.packed-item .col-4,
.packed-item .col-5 {
    padding: 0 5px;
}
</style>
{% endblock %}